<html>
<head>
	<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="report.css" type="text/css"/>
	<title></title>
	<script type="text/javascript" src="report.js"></script>
	<script type="text/javascript" src="link_popup.js"></script>
	<script type="text/javascript" src="tooltip.js"></script>
</head>
<body style="margin-left: 10px; margin-right: 10px; margin-top: 10px; margin-bottom: 10px;">
	<div style="position:absolute; z-index:21; visibility:hidden" id="vplink">
		<table border="1" cellpadding="0" cellspacing="0" bordercolor="#A9BFD3">
			<tr>
				<td>
					<table border="0" cellpadding="0" width="100%" cellspacing="0">
						<tr style="background:#DDDDDD">
							<td style="font-size: 12px;" align="left">
								<select onchange="vpLinkToggleName()" id="vplink-linkType">
	<option value="Project Link">Project Link</option>
	<option value="Page URL">Page URL</option>
</select>
							</td>
							<td style="font-size: 12px;" align="right">
								<input onclick="javascript: vpLinkToggleName()" id="vplink-checkbox" type="checkbox" />
								<label for="vplink-checkbox">with Name</label>							</td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td>
					<textarea id="vplink-text" style="width: 348px; height: 60px; border-color: #7EADD9; outline: none;"></textarea>				</td>
			</tr>
		</table>
	</div>
	<div class="HeaderText">
		<span>
NCI Business Architecture		</span>
	</div>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="HeaderLine1">
			</td>
		</tr>
		<tr>
			<td class="HeaderLine2">
			</td>
		</tr>
		<tr>
			<td class="HeaderLine3">
			</td>
		</tr>
	</table>
	<p>
<a href="Model_XXlgHBaAUrCKOWPo.html" class="PageParentTitle">ERModel : Model</a><span class="PageParentTitle">&nbsp;.&nbsp;</span><a href="Package_A3lgHBaAUrCKOWPt.html" class="PageParentTitle">dbo : Package</a>	</p>
	<p class="PageTitle">
Stored Procedures - StoredProcedures<a onclick="javascript: showVpLink('NCI Buisness Architecture.vpp://modelelement/Q3lgHBaAUrCKOWPu', 'StoredProcedures\nNCI Buisness Architecture.vpp://modelelement/Q3lgHBaAUrCKOWPu', 'StoredProcedures', this); return false;" style="padding-left: 16px; font-size: 12px" href="#"><img src="../images/icons/link.png" border="0"> link</a>	</p>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="Category">
Properties			</td>
		</tr>
		<tr>
			<td class="TableCellSpaceHolder5PxTall">
			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="Category">
Procedures Detail			</td>
		</tr>
		<tr>
			<td class="TableCellSpaceHolder5PxTall">
			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportContractData</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportContractData]<br>AS<br>BEGIN<br>    DECLARE @qry varchar(max);<br>    DECLARE @t TABLE(<br>                ContractNumber varchar(128) INDEX IX1<br>				,VendorName varchar(128)<br>				,VendorDUNS varchar(128)<br>				,UPIID varchar(128)<br>				,TP_KEY varchar(128)<br>				,ToCount int<br>            );<br><br>    BEGIN<br>        SET @qry = null;<br><br>        BEGIN<br>            set @qry = 'SELECT<br>						DISTINCT CASE<br>							WHEN ULTIMATE_PIID IS NOT NULL AND ULTIMATE_RefPIID IS NULL THEN ULTIMATE_PIID<br>							ELSE ULTIMATE_RefPIID<br>						END AS ContractNumber<br>						,VendorName<br>						,VendorDUNS<br>						,UPIID<br>						,TP_KEY<br>						,CASE<br>							WHEN ULTIMATE_RefPIID IS NOT NULL THEN COUNT(ULTIMATE_PIID) OVER(PARTITION BY ULTIMATE_RefPIID ORDER BY ULTIMATE_RefPIID) <br>							ELSE NULL<br>						END AS ToCount<br>					FROM(<br>					SELECT<br>						CASE<br>							WHEN PIID IS NOT NULL THEN PIID<br>							WHEN PIID IS NULL THEN PARENT_SEGMENT<br>						END AS Ultimate_PIID<br>						,CASE<br>							WHEN a.REFERENCED_PIID IS NOT NULL AND a.REFERENCED_PIID != ''000000000000000'' THEN a.REFERENCED_PIID<br>							WHEN REFERENCED_PIID IS NULL THEN PARENT_SEGMENT<br>							WHEN REFERENCED_PIID = ''000000000000000'' THEN NULL<br>						END AS Ultimate_RefPIID<br>						,a.AWARD_TYPE<br>						,t.TP_NAME AS VendorName<br>						,t.DUNS AS VendorDUNS<br>						,CASE<br>							WHEN NGPULLBACK_PIID LIKE ''%75N%'' THEN NGPULLBACK_PIID<br>							ELSE NULL<br>						END AS UPIID<br>						,CAST(t.TRADING_PARTNER_KEY AS VARCHAR(25)) AS TP_KEY<br>					FROM BF_AWD_HDR_ACQ_MV a <br>					LEFT JOIN BF_OBLIG_DTLS_ACQ_MV o ON o.AWARD_KEY = a.AWARD_KEY<br>					LEFT JOIN BF_TRADING_PARTNER_DIM_VW t ON t.TRADING_PARTNER_KEY = a.TRADING_PARTNER_KEY<br>					WHERE 1=1<br>					AND (o.IC = ''NCI'' OR a.BUYER_IC = ''NCI'')<br>					AND a.AWARD_CATEGORY_NAME != ''P-CARD''<br>					AND a.VERSION_NBR != ''-1''<br>					ORDER BY ULTIMATE_RefPIID, ULTIMATE_PIID<br>					)t'<br><br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br>        END<br><br>    END;<br><br>        DISABLE TRIGGER audit_PostAward_ContractData ON PostAward.ContractData;<br><br>        UPDATE cd SET<br>				cd.TaskOrderCount				= t.ToCount,<br>				cd.VendorDuns					= t.VendorDUNS,<br>				cd.VendorName					= t.VendorName,<br>				cd.VendorTradingPartnerKey		= t.TP_KEY,<br>				cd.UpiidNumber					= t.UPIID<br>        FROM PostAward.ContractData AS cd<br>		JOIN @t t ON t.ContractNumber = cd.Number<br>		WHERE cd.Number = t.ContractNumber<br><br>        --INSERT NEW ContractData<br>        INSERT INTO PostAward.ContractData(<br>				Number,<br>				TaskOrderCount,<br>				VendorDuns,<br>				VendorName,<br>				VendorTradingPartnerKey,<br>				UpiidNumber<br>            )<br>		SELECT <br>			t.ContractNumber, <br>			t.ToCount, <br>			t.VendorDUNS, <br>			t.VendorName, <br>			t.TP_KEY, <br>			t.UPIID<br>			FROM @t t <br>        LEFT JOIN PostAward.ContractData cd ON cd.Number = t.ContractNumber<br>        WHERE cd.Number is null;<br><br>        ENABLE TRIGGER audit_Core_ContractData ON Core.ContractData;<br><br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportContractData</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">curId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">endId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceClin</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportFinanceClin] @curId int = null, @endId int = null<br>AS<br>BEGIN <br>    DECLARE @windowSize INT<br>    DECLARE @inStr varchar(max);<br>    DECLARE @qry varchar(max);<br>    DECLARE @purchOrderNumber TABLE( <br>        ContractId int INDEX ix1<br>        ,PurchaseOrderNumber varchar(64) INDEX ix2    )<br>    DECLARE @t TABLE(<br>                PURCH_ORDER_NBR varchar(128) INDEX IX1<br>				,LineItemNumber int<br>				,Obligated FLOAT<br>				,Invoiced FLOAT<br>				,Remaining FLOAT<br>				,PercentInvoiced FLOAT<br>				,FY int<br>				,CAN int<br>				,IC varchar(128)<br>				,DateOfObligation DATETIME2<br>				,FundsAvailabilityEndDate DATETIME2<br>				,PerformanceStartDate DATETIME2<br>				,PerformanceEndDate DATETIME2<br>            );<br><br>    SET @windowSize = 900;<br>    IF (@curId IS NULL AND @endId IS NULL) <br>        BEGIN<br>            select @curId = MIN(ContractId) from Core.Contract;<br>            select @endid = MAX(ContractId) from Core.Contract;<br>        END<br>    ELSE <br>    BEGIN<br>        SET @windowSize = 1;<br>    END<br><br>    IF (@endId IS NULL) <br>        SET @endId = @curId;<br><br>    --Ensure we get the last in the range,<br>    SET @endId = @endId + 1;<br><br>    INSERT INTO @purchOrderNumber(ContractId, PurchaseOrderNumber) <br>    SELECT <br>		DISTINCT CASE<br>			WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.ContractId<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN c.ContractId<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.ContractId<br>			WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.ContractId<br>			ELSE c.ContractId<br>		END <br>		,CASE <br>			WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.Number<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN p.Number + '/' + c.Number<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.Number<br>			WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.Number<br>			ELSE c.Number<br>		END<br>    FROM Core.Contract C<br>    LEFT JOIN Core.Contract P ON c.ParentId = p.ContractId<br><br><br>    PRINT @curId;<br>    PRINT @endId;<br><br>    WHILE @curId < @endid<br>    BEGIN<br>        SET @inStr = null;<br>        SET @qry = null;<br><br>        SELECT @inStr = COALESCE(@inStr + ', ', '') + '''' + p.PurchaseOrderNumber + '''' <br>        FROM [Core].[Contract] AS C <br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        WHERE c.ContractId >= @curId AND c.ContractId < (@curId + @windowSize);<br>        --PRINT @inStr;<br><br>        if (@inStr != '')<br>        BEGIN<br>            set @qry = '<br>					SELECT<br>						DISTINCT a.PURCH_ORDER_NBR<br>						,o.AWARD_LINE_NBR AS LineItemNumber<br>						,ROUND(o.GL_OBLIGATION_AMT,2) AS Obligated<br>						,ROUND(o.QUANTITY_BILLED,2) AS Invoiced<br>						,ROUND((SELECT o2.GL_OBLIGATION_AMT - o2.QUANTITY_BILLED FROM BF_OBLIG_DTLS_ACQ_MV o2 WHERE o2.OBLIG_DTLS_KEY = o.OBLIG_DTLS_KEY),2) AS Remaining<br>						,(SELECT ROUND((o.QUANTITY_BILLED/NULLIF(o.GL_OBLIGATION_AMT,0))*100,2) FROM BF_OBLIG_DTLS_ACQ_MV o2 WHERE o2.OBLIG_DTLS_KEY = o.OBLIG_DTLS_KEY) AS PercentInvoiced<br>						,o.BUDGET_FY AS FY<br>						,o.CAN AS CAN<br>						,o.IC AS IC<br>						,o.OBLIG_CREATED_DT AS DateOfObligation<br>						,a.END_DT AS FundsAvailabilityEndDate<br>						,p.CURR_PERF_START_DT AS PerformanceStartDate<br>						,p.CURR_PERF_END_DT AS PerformanceEndDate<br>					FROM BF_AWD_HDR_ACQ_MV a<br>					LEFT JOIN BF_PRISM_OBLIG_DTLS_1_ACQ_MV p ON p.HDRDOCKEY = a.DOCKEY AND p.HDRVERKEY = a.VERKEY<br>					JOIN BF_OBLIG_DTLS_ACQ_MV o ON o.AWARD_KEY = a.AWARD_KEY<br>						AND (CASE WHEN o.VERSIONNUM = ''ORIG'' THEN ''0'' WHEN LENGTH(o.VERSIONNUM) = 6 THEN SUBSTR(o.VERSIONNUM,-4) ELSE o.VERSIONNUM END) = (CASE WHEN LENGTH(a.VERSION_NBR) = 6 THEN SUBSTR(a.VERSION_NBR,-4) ELSE a.VERSION_NBR END)<br>					WHERE 1=1<br>					AND a.PURCH_ORDER_NBR IN (' + @inStr + ')<br>					ORDER BY LineItemNumber, DateofObligation';<br>            --PRINT 'qry = ' + @qry;<br>			<br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br>        END<br><br>		<br><br>        set @curId = @curId + @windowSize;<br>    END;<br><br>        DISABLE TRIGGER audit_Core_ContractFinanceClin ON Core.ContractFinanceClin;<br><br>        UPDATE cfc SET<br>				cfc.LineItemNumber = t.LineItemNumber<br>				,cfc.Obligated = t.Obligated<br>				,cfc.Invoiced = t.Invoiced<br>				,cfc.Remaining = t.Remaining<br>				,cfc.PercentInvoiced = t.PercentInvoiced<br>				,cfc.FiscalYear = t.FY<br>				,cfc.Can = t.CAN<br>				,cfc.InstituteCenter = t.IC<br>				,cfc.DateOfObligation = t.DateOfObligation<br>				,cfc.FundsAvailabilityEndDate = t.FundsAvailabilityEndDate<br>				,cfc.PerformanceStartDate = t.PerformanceStartDate<br>				,cfc.PerformanceEndDate = t.PerformanceEndDate<br>        FROM Core.ContractFinanceClin AS cfc<br>        JOIN Core.Contract AS c ON cfc.ContractId = c.ContractId<br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        JOIN @t t ON t.PURCH_ORDER_NBR = p.PurchaseOrderNumber<br>		--Do we need mod here?<br>		--AND t.MOD = cm.ModificationNumber<br><br>        --INSERT NEW FinanceClinData<br>        INSERT INTO Core.ContractFinanceClin(<br>            ContractId<br>			,LineItemNumber <br>			,Obligated <br>			,Invoiced <br>			,Remaining <br>			,PercentInvoiced <br>			,FiscalYear <br>			,Can <br>			,InstituteCenter<br>			,DateOfObligation <br>			,FundsAvailabilityEndDate <br>			,PerformanceStartDate <br>			,PerformanceEndDate<br>            )<br>        SELECT<br>            (SELECT TOP 1 c.ContractId<br>                FROM Core.Contract c<br>                LEFT JOIN Core.Contract p ON p.ContractId = c.ParentId<br>                WHERE t.PURCH_ORDER_NBR = <br>				(<br>				CASE <br>					WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.Number<br>					WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN p.Number + '/' + c.Number<br>					WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.Number<br>					WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.Number<br>					ELSE NULL<br>				END<br>				))<br>				,t.LineItemNumber <br>				,t.Obligated<br>				,t.Invoiced<br>				,t.Remaining <br>				,t.PercentInvoiced <br>				,t.FY <br>				,t.CAN <br>				,t.IC<br>				,t.DateOfObligation <br>				,t.FundsAvailabilityEndDate <br>				,t.PerformanceStartDate <br>				,t.PerformanceEndDate<br>        FROM @t t<br>        LEFT JOIN (<br>            SELECT cfc.ContractId, p.PurchaseOrderNumber, cfc.LineItemNumber, cfc.Obligated, cfc.Can<br>                FROM Core.ContractFinanceClin cfc<br>                JOIN Core.Contract c ON cfc.ContractId = c.ContractId<br>				JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>            ) ex ON ex.PurchaseOrderNumber = t.PURCH_ORDER_NBR<br>				AND ex.LineItemNumber = t.LineItemNumber<br>				AND ex.Obligated = t.Obligated<br>				AND ex.Can = t.CAN<br>        WHERE ex.ContractId is null;<br><br>        ENABLE TRIGGER audit_Core_ContractFinanceClin ON Core.ContractFinanceClin;<br><br>    IF EXISTS (<br>    SELECT * <br>    FROM   sys.columns <br>    WHERE  object_id = OBJECT_ID(N'[CORE].[Contract]') <br>            AND name = 'PurchaseOrderNumber'<br>    ) <br>    BEGIN  <br>        DROP INDEX [Core].[Contract].IX_CORE_CONTRACT_PURCHASE_ORDER_NUMBER;<br>        ALTER TABLE Core.Contract <br>            DROP COLUMN PurchaseOrderNumber;<br>    END<br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceClin</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">curId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">endId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceDashboard</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportFinanceDashboard] @curId int = null, @endId int = null<br>AS<br>BEGIN <br>    DECLARE @windowSize INT<br>    DECLARE @inStr varchar(max);<br>    DECLARE @qry varchar(max);<br>    DECLARE @purchOrderNumber TABLE( <br>        ContractId int INDEX ix1<br>        ,PurchaseOrderNumber varchar(64) INDEX ix2    )<br>    DECLARE @t TABLE(<br>                PURCH_ORDER_NBR varchar(128) INDEX IX1<br>				,MOD varchar(max)<br>				,RowNumber int<br>				,CurrentContractCeiling FLOAT<br>				,ContractPotentialValue FLOAT<br>				,TotalObligated FLOAT<br>				,RemainingUnobligated FLOAT<br>            );<br><br>    SET @windowSize = 900;<br>    IF (@curId IS NULL AND @endId IS NULL) <br>        BEGIN<br>            select @curId = MIN(ContractId) from Core.Contract;<br>            select @endid = MAX(ContractId) from Core.Contract;<br>        END<br>    ELSE <br>    BEGIN<br>        SET @windowSize = 1;<br>    END<br><br>    IF (@endId IS NULL) <br>        SET @endId = @curId;<br><br>    --Ensure we get the last in the range,<br>    SET @endId = @endId + 1;<br><br>    INSERT INTO @purchOrderNumber(ContractId, PurchaseOrderNumber) <br>    SELECT C.ContractId, CASE WHEN p.Number IS NULL THEN '' ELSE p.Number + '/' END + c.Number<br>    FROM Core.Contract C<br>    LEFT JOIN Core.Contract P ON c.ParentId = p.ContractId<br><br>    PRINT @curId;<br>    PRINT @endId;<br><br>    WHILE @curId < @endid<br>    BEGIN<br>        SET @inStr = null;<br>        SET @qry = null;<br><br>        SELECT @inStr = COALESCE(@inStr + ', ', '') + '''' + p.PurchaseOrderNumber + '''' <br>        FROM [Core].[Contract] AS C <br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        WHERE c.ContractId >= @curId AND c.ContractId < (@curId + @windowSize);<br>        --PRINT @inStr;<br><br>        if (@inStr != '')<br>        BEGIN<br>            set @qry = '<br>					SELECT * FROM (<br>					SELECT <br>						DISTINCT a.PURCH_ORDER_NBR<br>						,a.VERSION_NBR AS MOD<br>						,ROW_NUMBER() OVER(PARTITION BY a.PURCH_ORDER_NBR ORDER BY a.VERSION_NBR DESC) AS RowNumber<br>						,a.TOTAL_CONTRACT_VALUE AS CurrentContractCeiling<br>						,a.PRISM_POT_AWARD_AMT AS ContractPotentialValue<br>						,a.PRISM_CUMULATIVE_OBLG_AMT AS TotalObligated<br>						,a.TOTAL_CONTRACT_VALUE - NVL(a.PRISM_CUMULATIVE_OBLG_AMT,0) AS RemainingUnobligated<br>					FROM BF_AWD_HDR_ACQ_MV a<br>					WHERE 1=1<br>					AND a.PURCH_ORDER_NBR IN (' + @inStr + ')<br>					)t<br>					WHERE RowNumber = 1<br>					ORDER BY PURCH_ORDER_NBR, MOD';<br>            --PRINT 'qry = ' + @qry;<br><br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br>        END<br><br>        set @curId = @curId + @windowSize;<br>    END;<br><br>        DISABLE TRIGGER audit_Core_ContractFinanceDashboard ON Core.ContractFinanceDashboard;<br><br>        UPDATE cfd SET<br>				cfd.CurrentContractCeiling								= t.CurrentContractCeiling<br>				,cfd.ContractPotentialValue								= t.ContractPotentialValue<br>				,cfd.TotalObligated										= t.TotalObligated<br>				,cfd.RemainingUnobligated								= t.RemainingUnobligated<br>        FROM Core.ContractFinanceDashboard AS cfd<br>        JOIN Core.Contract AS c ON cfd.ContractId = c.ContractId<br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        JOIN @t t ON t.PURCH_ORDER_NBR = p.PurchaseOrderNumber<br>		--Do we need mod here?<br>		--AND t.MOD = cm.ModificationNumber<br><br>        --INSERT NEW FinanceDashboardData<br>        INSERT INTO Core.ContractFinanceDashboard(<br>            ContractId<br>			,CurrentContractCeiling<br>			,ContractPotentialValue<br>			,TotalObligated<br>			,RemainingUnobligated<br>            )<br>        SELECT<br>            (SELECT TOP 1 c.ContractId<br>                FROM Core.Contract c<br>                LEFT JOIN Core.Contract p ON p.ContractId = c.ParentId<br>                WHERE t.PURCH_ORDER_NBR = (CASE WHEN p.Number IS NULL THEN '' ELSE p.Number + '/' END + c.Number))<br>				,CurrentContractCeiling<br>				,ContractPotentialValue<br>				,TotalObligated<br>				,RemainingUnobligated<br>        FROM @t t <br>        LEFT JOIN (<br>            SELECT cfd.ContractId, p.PurchaseOrderNumber<br>                FROM Core.ContractFinanceDashboard cfd<br>                JOIN Core.Contract c ON cfd.ContractId = c.ContractId<br>				JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>            ) ex ON ex.PurchaseOrderNumber = t.PURCH_ORDER_NBR<br>        WHERE ex.ContractId is null;<br><br>        ENABLE TRIGGER audit_Core_ContractFinanceDashboard ON Core.ContractFinanceDashboard;<br><br>    IF EXISTS (<br>    SELECT * <br>    FROM   sys.columns <br>    WHERE  object_id = OBJECT_ID(N'[CORE].[Contract]') <br>            AND name = 'PurchaseOrderNumber'<br>    ) <br>    BEGIN  <br>        DROP INDEX [Core].[Contract].IX_CORE_CONTRACT_PURCHASE_ORDER_NUMBER;<br>        ALTER TABLE Core.Contract <br>            DROP COLUMN PurchaseOrderNumber;<br>    END<br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceDashboard</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">curId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">endId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceHistory</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportFinanceHistory] @curId int = null, @endId int = null<br>AS<br>BEGIN <br>    DECLARE @windowSize INT<br>    DECLARE @inStr varchar(max);<br>    DECLARE @qry varchar(max);<br>    DECLARE @purchOrderNumber TABLE( <br>        ContractId int INDEX ix1<br>        ,PurchaseOrderNumber varchar(64) INDEX ix2    )<br>    DECLARE @t TABLE(<br>                PURCH_ORDER_NBR varchar(128) INDEX IX1<br>				,Action varchar(128)<br>				,IdNumber varchar(128)<br>				,Clin int<br>				,ActionDate DATETIME2<br>				,Obligated FLOAT<br>				,PaymentAmount FLOAT<br>				,ActualAmount FLOAT<br>				,PercentRemaining FLOAT<br>				,RemainingObligated FLOAT<br>            );<br><br>    SET @windowSize = 900;<br>    IF (@curId IS NULL AND @endId IS NULL) <br>        BEGIN<br>            select @curId = MIN(ContractId) from Core.Contract;<br>            select @endid = MAX(ContractId) from Core.Contract;<br>        END<br>    ELSE <br>    BEGIN<br>        SET @windowSize = 1;<br>    END<br><br>    IF (@endId IS NULL) <br>        SET @endId = @curId;<br><br>    --Ensure we get the last in the range,<br>    SET @endId = @endId + 1;<br><br>    INSERT INTO @purchOrderNumber(ContractId, PurchaseOrderNumber) <br>    SELECT <br>		C.ContractId, <br>		CASE <br>			WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.Number<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN p.Number + '/' + c.Number<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.Number<br>			WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.Number<br>			ELSE c.Number<br>		END<br>    FROM Core.Contract C<br>    LEFT JOIN Core.Contract P ON c.ParentId = p.ContractId<br><br>    PRINT @curId;<br>    PRINT @endId;<br><br>    WHILE @curId < @endid<br>    BEGIN<br>        SET @inStr = null;<br>        SET @qry = null;<br><br>        SELECT @inStr = COALESCE(@inStr + ', ', '') + '''' + p.PurchaseOrderNumber + '''' <br>        FROM [Core].[Contract] AS C <br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        WHERE c.ContractId >= @curId AND c.ContractId < (@curId + @windowSize);<br>        --PRINT @inStr;<br><br>        if (@inStr != '')<br>        BEGIN<br>            set @qry = '<br>					SELECT<br>                        PURCH_ORDER_NBR<br>                        ,Action<br>                        ,IDNumber<br>                        ,Clin<br>                        ,ActionDate<br>                        ,Obligated<br>                        ,PaymentAmount<br>                        ,ActualAmount<br>                        ,ROUND((RemainingObligated / NULLIF(OriginalObligation,0))*100,2) AS PercentRemaining<br>                        ,RemainingObligated<br>                    FROM<br>                    (<br>                        SELECT <br>                            DISTINCT PURCH_ORDER_NBR<br>                            ,Action<br>                            ,IDNumber<br>                            ,Clin<br>                            ,ActionDate<br>                            ,Obligated<br>                            ,PaymentAmount<br>                            ,ActualAmount<br>                            ,(SELECT SUM(p.OBLIGATED_AMT) FROM BF_AWD_HDR_ACQ_MV a LEFT JOIN BF_PRISM_OBLIG_DTLS_1_ACQ_MV p ON p.HDRDOCKEY = a.DOCKEY AND p.HDRVERKEY = a.VERKEY WHERE a.PURCH_ORDER_NBR = h.PURCH_ORDER_NBR AND a.VERSION_NBR = ''0'') AS OriginalObligation<br>                            ,SUM(ActualAmount) OVER(ORDER BY ActionDate, Clin, IDNumber ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RemainingObligated<br>                        FROM <br>                        (<br>                            SELECT<br>                                DISTINCT a.PURCH_ORDER_NBR<br>                                ,''Original Award'' AS Action<br>                                ,a.PURCH_ORDER_NBR AS IDNumber<br>                                ,p.LI# AS Clin<br>                                ,a.AWARD_DT AS ActionDate<br>                                ,p.OBLIGATED_AMT AS Obligated<br>                                ,NULL AS PaymentAmount<br>                                ,p.OBLIGATED_AMT AS ActualAmount<br>                            FROM BF_AWD_HDR_ACQ_MV a<br>                            LEFT JOIN BF_PRISM_OBLIG_DTLS_1_ACQ_MV p ON p.HDRDOCKEY = a.DOCKEY AND p.HDRVERKEY = a.VERKEY<br>                            WHERE a.VERSION_NBR != ''0''<br>                            --AND a.PURCH_ORDER_NBR IN (' + @inStr + ')<br>        <br>                            UNION<br>        <br>                            SELECT<br>                                DISTINCT a.PURCH_ORDER_NBR<br>                                ,''Mod'' AS Action<br>                                ,a.VERSION_NBR AS IDNumber<br>                                ,p.LI# AS Clin<br>                                ,a.AWARD_DT AS ActionDate<br>                                ,p.OBLIGATED_AMT AS Obligated<br>                                ,NULL AS PaymentAmount<br>                                ,p.OBLIGATED_AMT AS ActualAmount<br>                            FROM BF_AWD_HDR_ACQ_MV a<br>                            LEFT JOIN BF_PRISM_OBLIG_DTLS_1_ACQ_MV p ON p.HDRDOCKEY = a.DOCKEY AND p.HDRVERKEY = a.VERKEY<br>                            WHERE a.VERSION_NBR != ''0''<br>                            --AND a.PURCH_ORDER_NBR IN (' + @inStr + ')<br>                            AND NVL(p.OBLIGATED_AMT,0) != 0<br>            <br>                            UNION<br>        <br>                            SELECT<br>                                DISTINCT a.PURCH_ORDER_NBR<br>                                ,''Invoice Paid'' AS Action<br>                                ,i.INVOICE_NBR AS IDNumber<br>                                ,i.AWARD_LINE_NBR AS Clin<br>                                ,i.INVOICE_DT AS ActionDate<br>                                ,NULL AS Obligated<br>                                ,i.AP_DOC_AMT AS PaymentAmount<br>                                ,-1 * i.AP_DOC_AMT AS ActualAmount<br>                            FROM BF_AWD_HDR_ACQ_MV a<br>                            LEFT JOIN BF_AP_DTLS_INVOICES_ACQ_MV i ON i.PURCH_ORDER_NBR = a.PURCH_ORDER_NBR<br>                            LEFT JOIN BF_INVOICE_DIM id ON id.INVOICE_ID = i.INVOICE_ID<br>                            WHERE 1=1<br>                            AND id.PAYMENT_STATUS_FLG = ''FULLY PAID''<br>                            --AND a.PURCH_ORDER_NBR IN (' + @inStr + ')<br>                            AND NVL(id.INVOICE_AMT,0) != ''0''<br>                        )h<br>                    )p<br>                    ORDER BY ActionDate, Clin, IDNumber';<br><br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br>        END<br>		<br>        set @curId = @curId + @windowSize;<br>    END;<br><br>        DISABLE TRIGGER audit_Core_ContractFinanceHistory ON Core.ContractFinanceHistory;<br><br>        UPDATE cfh SET<br>				cfh.Action = t.Action,<br>				--cfh.IdNumber = t.IdNumber,<br>				cfh.Clin = t.Clin,<br>				cfh.ActionDate = t.ActionDate,<br>				cfh.Obligated = t.Obligated,<br>				cfh.PaymentAmount = t.PaymentAmount,<br>				cfh.PercentRemaining = t.PercentRemaining,<br>				cfh.RemaingObligated = t.RemainingObligated<br>        FROM Core.ContractFinanceHistory AS cfh<br>        JOIN Core.Contract AS c ON cfh.ContractId = c.ContractId<br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        JOIN @t t ON t.PURCH_ORDER_NBR = p.PurchaseOrderNumber<br>		WHERE cfh.IdNumber = t.IdNumber<br>		AND cfh.Clin = t.Clin<br>		--Do we need mod here?<br>		--AND t.MOD = cm.ModificationNumber<br><br>        --INSERT NEW ContractFinanceHistory<br>        INSERT INTO Core.ContractFinanceHistory(<br>            ContractId<br>			,Action<br>			,IdNumber<br>			,Clin<br>			,ActionDate<br>			,Obligated<br>			,PaymentAmount<br>			,PercentRemaining<br>			,RemaingObligated<br>            )<br>			SELECT * FROM<br>			(<br>			SELECT<br>            (SELECT TOP 1 c.ContractId<br>                FROM Core.Contract c<br>                LEFT JOIN Core.Contract p ON p.ContractId = c.ParentId<br>                WHERE t.PURCH_ORDER_NBR = <br>				(<br>				CASE <br>					WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.Number<br>					WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN p.Number + '/' + c.Number<br>					WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.Number<br>					WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.Number<br>					ELSE c.Number<br>				END<br>				)) AS ContractId<br>				,Action<br>				,t.IdNumber<br>				,t.Clin<br>				,ActionDate<br>				,Obligated<br>				,PaymentAmount<br>				,PercentRemaining<br>				,RemainingObligated<br>        FROM @t t <br>        LEFT JOIN (<br>            SELECT cfh.ContractId, p.PurchaseOrderNumber, cfh.IdNumber, cfh.Clin<br>                FROM Core.ContractFinanceHistory cfh<br>                JOIN Core.Contract c ON cfh.ContractId = c.ContractId<br>				JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>            ) ex ON ex.PurchaseOrderNumber = t.PURCH_ORDER_NBR<br>        WHERE ex.ContractId is null<br>		--only insert if that IdNumber and Clin doesn't already exist<br>		AND ex.IdNumber is null<br>		AND ex.Clin is null<br>		)c<br>		WHERE ContractId IS NOT NULL;<br><br>        ENABLE TRIGGER audit_Core_ContractFinanceHistory ON Core.ContractFinanceHistory;<br><br>    IF EXISTS (<br>    SELECT * <br>    FROM   sys.columns <br>    WHERE  object_id = OBJECT_ID(N'[CORE].[Contract]') <br>            AND name = 'PurchaseOrderNumber'<br>    ) <br>    BEGIN  <br>        DROP INDEX [Core].[Contract].IX_CORE_CONTRACT_PURCHASE_ORDER_NUMBER;<br>        ALTER TABLE Core.Contract <br>            DROP COLUMN PurchaseOrderNumber;<br>    END<br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceHistory</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">curId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">endId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceInvoicedAndPaid</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportFinanceInvoicedAndPaid] @curId int = null, @endId int = null<br>AS<br>BEGIN <br>    DECLARE @windowSize INT<br>    DECLARE @inStr varchar(max);<br>    DECLARE @qry varchar(max);<br>    DECLARE @purchOrderNumber TABLE( <br>        ContractId int INDEX ix1<br>        ,PurchaseOrderNumber varchar(64) INDEX ix2    )<br>    DECLARE @t TABLE(<br>                PURCH_ORDER_NBR varchar(128) INDEX IX1<br>				,TotalInvoiced FLOAT<br>				,TotalPaid FLOAT<br>            );<br><br>    SET @windowSize = 900;<br>    IF (@curId IS NULL AND @endId IS NULL) <br>        BEGIN<br>            select @curId = MIN(ContractId) from Core.Contract;<br>            select @endid = MAX(ContractId) from Core.Contract;<br>        END<br>    ELSE <br>    BEGIN<br>        SET @windowSize = 1;<br>    END<br><br>    IF (@endId IS NULL) <br>        SET @endId = @curId;<br><br>    --Ensure we get the last in the range,<br>    SET @endId = @endId + 1;<br><br>    INSERT INTO @purchOrderNumber(ContractId, PurchaseOrderNumber) <br>    SELECT C.ContractId, CASE WHEN p.Number IS NULL THEN '' ELSE p.Number + '/' END + c.Number<br>    FROM Core.Contract C<br>    LEFT JOIN Core.Contract P ON c.ParentId = p.ContractId<br><br>    PRINT @curId;<br>    PRINT @endId;<br><br>    WHILE @curId < @endid<br>    BEGIN<br>        SET @inStr = null;<br>        SET @qry = null;<br><br>        SELECT @inStr = COALESCE(@inStr + ', ', '') + '''' + p.PurchaseOrderNumber + '''' <br>        FROM [Core].[Contract] AS C <br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        WHERE c.ContractId >= @curId AND c.ContractId < (@curId + @windowSize);<br>        --PRINT @inStr;<br><br>        if (@inStr != '')<br>        BEGIN<br>            set @qry = '<br>					SELECT <br>					    DISTINCT a.PURCH_ORDER_NBR<br>					    ,(SELECT SUM(COALESCE(i.AP_DOC_AMT,0)) FROM BF_AP_DTLS_INVOICES_ACQ_MV i WHERE i.PURCH_ORDER_NBR = a.PURCH_ORDER_NBR)AS TotalInvoiced<br>					    ,(SELECT SUM(COALESCE(i.AP_DOC_AMT,0)) FROM BF_AP_DTLS_INVOICES_ACQ_MV i LEFT JOIN BF_INVOICE_DIM id ON id.INVOICE_ID = i.INVOICE_ID WHERE i.PURCH_ORDER_NBR = a.PURCH_ORDER_NBR AND (id.PAYMENT_STATUS_FLG = ''FULLY PAID'' OR i.PURCH_ORDER_NBR IS NULL)) AS TotalPaid<br>					FROM BF_AWD_HDR_ACQ_MV a<br>					WHERE <br>					    1=1<br>					    AND a.PURCH_ORDER_NBR IN (' + @inStr + ')';<br>            --PRINT 'qry = ' + @qry;<br><br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br>        END<br><br>        set @curId = @curId + @windowSize;<br>    END;<br><br>        DISABLE TRIGGER audit_Core_ContractFinanceDashboard ON Core.ContractFinanceDashboard;<br><br>        UPDATE cfd SET<br>				cfd.TotalInvoiced							= t.TotalInvoiced<br>				,cfd.TotalPaid								= t.TotalPaid<br>        FROM Core.ContractFinanceDashboard AS cfd<br>        JOIN Core.Contract AS c ON cfd.ContractId = c.ContractId<br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        JOIN @t t ON t.PURCH_ORDER_NBR = p.PurchaseOrderNumber<br>		--Do we need mod here?<br>		--AND t.MOD = cm.ModificationNumber<br><br>        --INSERT NEW ContractInvoicedAndPaid<br>        INSERT INTO Core.ContractFinanceDashboard(<br>            ContractId<br>			,TotalInvoiced<br>			,TotalPaid<br>            )<br>        SELECT<br>            (SELECT TOP 1 c.ContractId<br>                FROM Core.Contract c<br>                LEFT JOIN Core.Contract p ON p.ContractId = c.ParentId<br>                WHERE t.PURCH_ORDER_NBR = (CASE WHEN p.Number IS NULL THEN '' ELSE p.Number + '/' END + c.Number))<br>				,TotalInvoiced<br>				,TotalPaid<br>        FROM @t t <br>        LEFT JOIN (<br>            SELECT cfd.ContractId, p.PurchaseOrderNumber<br>                FROM Core.ContractFinanceDashboard cfd<br>                JOIN Core.Contract c ON cfd.ContractId = c.ContractId<br>				JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>            ) ex ON ex.PurchaseOrderNumber = t.PURCH_ORDER_NBR<br>        WHERE ex.ContractId is null;<br><br>        ENABLE TRIGGER audit_Core_ContractFinanceDashboard ON Core.ContractFinanceDashboard;<br><br>    IF EXISTS (<br>    SELECT * <br>    FROM   sys.columns <br>    WHERE  object_id = OBJECT_ID(N'[CORE].[Contract]') <br>            AND name = 'PurchaseOrderNumber'<br>    ) <br>    BEGIN  <br>        DROP INDEX [Core].[Contract].IX_CORE_CONTRACT_PURCHASE_ORDER_NUMBER;<br>        ALTER TABLE Core.Contract <br>            DROP COLUMN PurchaseOrderNumber;<br>    END<br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportFinanceInvoicedAndPaid</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">curId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
				<table border="0" cellpadding="0" width="100%" cellspacing="0">
					<tr class="SubtableHeader">
						<td class="TableCellSpaceHolder10Px">
						</td>
						<td width="25%">
<span class="TableHeaderText">Name</span>						</td>
						<td class="TableCellSpaceHolder20Px">
						</td>
						<td>
<span class="TableHeaderText">Value</span>						</td>
					</tr>
					<tr>
						<td colSpan="4" class="TableHeaderLine2">
						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">endId</span>						</td>
					</tr>
					<tr class="TableRow2">
						<td>
						</td>
						<td>
<span class="TableContent">Parameter Type</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">Unknown</span>						</td>
					</tr>
					<tr class="TableRow1">
						<td>
						</td>
						<td>
<span class="TableContent">Type Name</span>						</td>
						<td>
						</td>
						<td>
<span class="TableContent">int</span>						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportModsFromNvision</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportModsFromNvision] @curId int = null, @endId int = null<br>AS<br>BEGIN <br>    DECLARE @windowSize INT<br>    DECLARE @inStr varchar(max);<br>    DECLARE @qry varchar(max);<br>    DECLARE @purchOrderNumber TABLE( <br>        ContractId int INDEX ix1<br>        ,PurchaseOrderNumber varchar(64) INDEX ix2    )<br>    DECLARE @t NvisionModData;<br><br>    SET @windowSize = 900;<br>    IF (@curId IS NULL AND @endId IS NULL) <br>        BEGIN<br>            select @curId = MIN(ContractId) from Core.Contract;<br>            select @endid = MAX(ContractId) from Core.Contract;<br>        END<br>    ELSE <br>    BEGIN<br>        SET @windowSize = 1;<br>    END<br><br>    IF (@endId IS NULL) <br>        SET @endId = @curId;<br><br>    --Ensure we get the last in the range,<br>    SET @endId = @endId + 1;<br><br>    INSERT INTO @purchOrderNumber(ContractId, PurchaseOrderNumber) <br>    SELECT <br>		DISTINCT CASE<br>			WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.ContractId<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN c.ContractId<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.ContractId<br>			WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.ContractId<br>			ELSE c.ContractId<br>		END <br>		,CASE <br>			WHEN p.Number IS NULL AND (c.Number NOT LIKE 'G%' AND c.Number NOT LIKE 'S%' AND c.Number NOT LIKE 'N%') THEN c.Number<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number LIKE 'HHSN%' THEN p.Number + '/' + c.Number<br>			WHEN c.Number LIKE 'HHSN%' AND p.Number NOT LIKE 'HHSN%' THEN c.Number<br>			WHEN c.Number NOT LIKE 'HHSN%' AND p.Number IS NOT NULL THEN p.Number<br>			ELSE c.Number<br>		END<br>    FROM Core.Contract C<br>    LEFT JOIN Core.Contract P ON c.ParentId = p.ContractId<br><br>    PRINT @curId;<br>    PRINT @endId;<br><br>    WHILE @curId < @endid<br>    BEGIN<br>        SET @inStr = null;<br>        SET @qry = null;<br><br>        SELECT @inStr = COALESCE(@inStr + ', ', '') + '''' + p.PurchaseOrderNumber + '''' <br>        FROM [Core].[Contract] AS C <br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        WHERE c.ContractId >= @curId AND c.ContractId < (@curId + @windowSize);<br>        --PRINT @inStr;<br><br>        if (@inStr != '')<br>        BEGIN<br>            set @qry = 'SELECT DISTINCT <br>                        a.PURCH_ORDER_NBR<br>                        ,CASE WHEN a.PIID IS NOT NULL THEN a.PIID WHEN a.PIID IS NULL THEN a.PARENT_SEGMENT END AS PIID<br>                        ,CASE WHEN a.REFERENCED_PIID IS NOT NULL AND a.REFERENCED_PIID != ''000000000000000'' THEN a.REFERENCED_PIID WHEN a.REFERENCED_PIID IS NULL THEN a.PARENT_SEGMENT WHEN a.REFERENCED_PIID = ''000000000000000'' THEN NULL END AS RefPIID<br>                        ,CASE WHEN a.NGPULLBACK_PIID LIKE ''%75N%'' THEN a.NGPULLBACK_PIID ELSE NULL END AS UPIID<br>                        ,CASE WHEN a.NGPULLBACK_REFERENCEDPIID LIKE ''%75N%'' THEN a.NGPULLBACK_REFERENCEDPIID ELSE NULL END AS RefUPIID<br>                        --FPDS Data Fields<br>                        ,COALESCE(d.MOD_NUM_NG,a.VERSION_NBR) AS Modification_Number                         <br>                        ,ab.BUYER_NAME<br>                        ,a.AWARD_STATUS<br>                        ,d.FPDS_STATUS<br>                        ,d.REASON_FOR_MODIFICATION_NAME<br>                        ,a.SHORT_DSC<br>                        ,d.DESCRIPTION_OF_REQUIREMENT<br>                        ,d.DATE_SIGNED<br>                        ,d.EFFECTIVE_DATE<br>						,d.IDV_LAST_DATE<br>                        ,d.CURRENT_COMPLETION_DATE<br>                        ,d.ULTIMATE_COMPLETION_DATE<br>                        --Amount Fields <br>                        ,a.PRISM_AWD_VER_OBLG_AMT AS Obligation<br>                        ,CASE WHEN a.VERSION_NBR = 0 THEN a.TOTAL_CONTRACT_VALUE ELSE a.TOTAL_CONTRACT_VALUE - NVL(LAG (TOTAL_CONTRACT_VALUE) OVER (PARTITION BY a.PURCH_ORDER_NBR ORDER BY a.VERSION_NBR), TOTAL_CONTRACT_VALUE) END AS Base_And_Exercised <br>                        ,CASE WHEN a.VERSION_NBR = 0 THEN a.PRISM_POT_AWARD_AMT ELSE a.PRISM_POT_AWARD_AMT - NVL(LAG (PRISM_POT_AWARD_AMT) OVER (PARTITION BY a.PURCH_ORDER_NBR ORDER BY a.VERSION_NBR), PRISM_POT_AWARD_AMT) END AS Base_And_All<br>                        ,a.PRISM_CUMULATIVE_OBLG_AMT AS Total_Obligation<br>                        ,a.TOTAL_CONTRACT_VALUE AS Total_Base_And_Exercised<br>                        ,a.PRISM_POT_AWARD_AMT AS Total_Base_And_All<br>                        --end Amount Fields<br>                        ,d.SOLICITATION_IDENTIFIER<br>                        ,d.AGENCY_IDENTIFIER<br>                        ,d.AGENCY_NAME<br>                        ,d.OFFICE_CODE<br>                        ,d.OFFICE_NAME<br>                        ,d.FUNDING_AGENCY<br>                        --New field - Funding Office ID<br>                        ,d.FA_DODAAC<br>                        --end New field<br>                        ,d.FOREIGN_CONTRACT<br>                        ,d.REFERENCED_AGENCY_ID<br>                        ,d.INITIATIVE<br>                        ,d.FEE_PAID_USE_IDV<br>                        ,t.DUNS<br>                        ,t.TP_NAME<br>                        ,c.DOING_BUSINESS_AS_NAME<br>                        ,t.STREET_NBR<br>                        ,t.CITY<br>                        ,t.STATE<br>                        ,t.POSTAL_CD<br>                        ,t.COUNTRY<br>                        ,c.VENDOR_PHONE_NUM<br>                        ,c.VENDOR_FAX_NUM<br>                        ,d.CONGRESS_DIST_CONTACTOR<br>                        ,c.ORGANIZATIONAL_TYPE<br>                        ,c.VENDOR_EMPLOYEES_NUM<br>                        ,c.COUNTRY_OF_INCORPORATION<br>                        ,c.VENDOR_ANNUAL_REVENUE<br>                        ,d.CONTRACT_TYPE_NAME<br>                        ,d.INHERENTLY_GOV_FUNCTION<br>                        ,d.MULTIYEAR_CONTRACT<br>                        ,d.MAJOR_PROGRAM<br>                        ,d.NATIONAL_INTEREST_CODE<br>                        ,d.NATIONAL_INTEREST_CODE_NAME<br>                        ,d.COST_OR_PRICING_DATA<br>                        ,d.COST_OR_PRICING_DATA_NAME<br>                        ,d.PURCHASE_CARD_PAYMENT_METHOD<br>                        ,d.PURCHASE_CARD_METHOD_NAME<br>                        ,d.PERF_BASED_CONTRACT<br>                        ,d.CONTINGENCY_OPS<br>                        ,d.CONTINGENCY_OPS_NAME<br>                        ,d.CONTRACT_FINANCING<br>                        ,d.CONTRACT_FINANCING_NAME<br>                        ,d.COST_ACCOUNTING_STANDARD<br>                        ,d.COST_ACCOUNT_STANDARD_NAME<br>                        ,d.CONSOLIDATED_CONTRACT<br>                        ,d.CONSOLIDATED_CONTRACT_NAME<br>                        ,d.NUMBER_OF_ACTIONS<br>                        ,d.FA_CLINGER<br>                        ,d.FA_CLINGER_NAME<br>                        ,d.LABOR_STATUTES<br>                        ,d.INTERAGENCY_CONTRACT_AUTHORITY<br>                        ,d.INTERAGE_CONTR_AUTHORITY_NAME<br>                        ,d.OTHER_STATUTORY_AUTHORITY<br>                        ,d.STATE_PERFORM<br>                        ,d.STATE_PERFORM_NAME<br>                        ,d.COUNTRY_PERFORM<br>                        ,d.COUNTRY_PERFORM_NAME<br>                        ,d.CITY_PERFORM<br>                        ,d.CITY_PERFORM_NAME<br>                        ,d.CONGRESS_DIST_POP<br>                        ,d.ZIP_CODE_POP<br>                        ,d.EXTENT_COMPETED_NG<br>                        ,d.EXTENT_COMPETED_NAME<br>                        ,d.SOLICITATION_PROCEDURES_NG<br>                        ,d.SOLICITATION_PROCEDURES_NAME<br>                        ,d.TYPE_SET_ASIDE<br>                        ,d.TYPE_SET_ASIDE_NAME<br>                        ,d.EVALUATED_PREFERENCE<br>                        ,d.EVALUATED_PREFERENCE_NAME<br>                        ,d.LOCAL_AREA_SET_ASIDE<br>                        ,d.LOCAL_AREA_SET_ASIDE_NAME<br>                        ,d.FEDBIZOPPS<br>                        ,d.FEDBIZOPPS_NAME<br>                        ,d.A76<br>                        ,d.A76_ACTION_NAME<br>                        ,d.COMMERCIAL_ITEM_ACQUISITION<br>                        ,d.COMM_ITEM_ACQUISITION_NAME<br>                        ,d.NUM_OFFERS_RECD_NG<br>                        ,d.SMALL_BUSINESS_DEMO<br>                        ,d.SUBCONTRACT_PLAN_NG<br>                        ,d.SUBCONTRACT_PLAN_NG_NAME<br>                        ,d.PRICE_EVAL_DIFF<br>                    -- NIH Data Fields<br>                        ,d.KEY_PERSONNEL_FIRST_NAME<br>                        ,d.KEY_PERSONNEL_LAST_NAME	<br>                        ,d.KEY_PERSONNEL_EMAIL	<br>                        ,d.PROJ_OFFICER_FIRST_NAME	<br>                        ,d.PROJ_OFFICER_LAST_NAME	<br>                        ,d.PROJ_OFFICER_EMAIL	<br>                        ,d.CONTR_SPECIALIST_FIRST_NAME	<br>                        ,d.CONTR_SPECIALIST_LAST_NAME	<br>                        ,d.CONTR_SPECIALIST_EMAIL	<br>                        ,d.RFC_DATE	<br>                        ,d.CONTRACT_STATUS	<br>                        ,d.CONTRACT_STATUS_NAME<br>                        ,d.CENTER	<br>                        ,d.INDIAN_SELF_DETERMINATION	<br>                        ,d.GREEN_PRODUCTS_SERVICES	<br>                        ,d.GREEN_PRODUCTS_SERVICES_DOLL	<br>                        ,d.PROCUREMENT_ACTION_NIH	<br>                        ,d.PROCUREMENT_ACTION_NAME<br>                        ,d.ACTIVITY_CODE_NIH	<br>                        ,d.ACTIVITY_CODE_NAME<br>                        ,d.ADMIN_IC_NIH<br>                        ,d.ADMIN_IC_NAME<br>                        ,d.FORMER_NUM_NIH	<br>                        ,d.ADB_CONTRACT_NUM_NIH	<br>                        ,d.ACTION_EFFECTIVE_DATE_NIH	<br>                        ,d.FISCAL_YEAR_NIH	<br>                        ,d.TOTAL_AWD_TO_DATE_DOL_NIH	<br>                        ,d.TOTAL_SUB_PLAN_DOL_NIH	<br>                        ,d.SUB_PLAN_SM_BUS_GOAL_DOL_NIH	<br>                        ,d.SUB_PLAN_DISADV_BUS_DOL_NIH	<br>                        ,d.SUB_PLAN_WOMEN_DOL_NIH	<br>                        ,d.SUB_PLAN_HUBZONE_DOL_NIH	<br>                        ,d.SUB_PLAN_VET_GOAL_DOL_NIH	<br>                        ,d.SUB_PLAN_DIS_VET_DOL_NIH	<br>                        ,d.HUMAN_SUBJECTS_CODE_NIH	<br>                        ,d.HUMAN_SUBJECTS_CODE_NAME<br>                        ,d.HUMAN_EMB_STEM_CELL	<br>                        ,d.LAST_REC_ON_FILE_NIH	<br>                        ,d.CURRENT_FUND_END_DATE_NIH	<br>                        ,d.AGENT_CODE_NIH	<br>                        ,d.COMP_SERVICE_CENTER_NAME	<br>                        ,d.SBIR_RESEARCH_CODE_NIH	<br>                        ,d.AIDS_RELATED_DOL_NIH	<br>                        ,d.AIDS_AFF_CONTRACT_NIH	<br>                        ,d.PRIVACY_ACT_APPLICABLE_NIH	<br>                        ,d.GOV_PROPERTY_NIH	<br>                        ,d.GOV_PROPERTY_NAME<br>                        ,d.CHILDREN_NIH	<br>                        ,d.CHILDREN_NAME<br>                        ,d.CHILDREN_REP_B1_NIH	<br>                        ,d.CHILDREN_REP_B1_NAME<br>                        ,d.CLINICAL_RES_MIN_B1_NIH	<br>                        ,d.CLINICAL_RES_MIN_B1_NAME<br>                        ,d.CLINICAL_RES_GEN_B1_NIH	<br>                        ,d.CLINICAL_RES_GEN_B1_NAME<br>                        ,d.PHASE3_TRIAL_NIH	<br>                        ,d.PHASE3_TRIAL_NAME<br>                        ,d.EXCEPTION_TRACKING_NIH	<br>                        ,d.EXCEPTION_TRACKING_NAME<br>                        ,d.CONTRACT_OFFICER_FIR_NAME_NIH	<br>                        ,d.CONTRACT_OFFICER_LAS_NAME_NIH	<br>                        ,d.TASK_ORDER_AGREEMENT_NIH	<br>                        ,d.TASK_ORDER_AGREE_NAME<br>                        ,d.RFP_IFB_NUM_NIH	<br>                        ,d.CONTRACT_ADMIN_CLOSE_DATE_NIH	<br>                        ,d.FCRDC_MEMO_AREA_NIH	<br>                        ,d.FCRDC_MEMO_AREA_NAME<br>                        ,d.ANIMALS_RESEARCH_NIH	<br>                        ,d.CHIMPANZEE_INVOLVEMENT	<br>                        ,d.ACTION_DOLLARS	<br>                        ,d.PROGRAM_CLASS_CODE_NIH	<br>                        ,d.DELEGATED_PROCUREMENT	<br>                        ,d.EMERGENCY_CONTRACT	<br>                        ,d.PAST_PERFORMANCE_REPORTING<br>                    FROM BF_AWD_HDR_ACQ_MV a<br>                    LEFT JOIN ACQ_EDW.BF_DCIS_CONTRACT_ACTIONS_VW d ON d.AWD_HDR_KEY = a.AWD_HDR_KEY<br>                    LEFT JOIN BF_EDW.BF_AWD_HDR_ACQ_BUYER_LOV ab ON ab.AWD_HDR_KEY = a.AWD_HDR_KEY<br>                    LEFT JOIN BF_EDW.BF_TRADING_PARTNER_DIM_VW t ON t.TRADING_PARTNER_KEY = a.TRADING_PARTNER_KEY<br>                    LEFT JOIN ACQ_EDW.BF_DCIS_CONTRACTOR_INFO_VW c ON c.CONTRACTOR_KEY = d.CONTRACTOR_KEY AND c.CONTRACTOR_ID = d.CONTRACTOR_ID<br>                    WHERE a.PURCH_ORDER_NBR IN (' + @inStr + ')';<br>            --PRINT 'qry = ' + @qry;<br>            <br>            <br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br>        END<br><br>        set @curId = @curId + @windowSize;<br>    END;<br><br>        --INSERT NEW MODS, We only create a simple entry, the update will take care of the rest of the fields.<br>        INSERT INTO Core.ContractModification(<br>            ContractId<br>            ,ModificationNumber)<br>        SELECT<br>            (SELECT TOP 1 c.ContractId<br>                FROM Core.Contract c<br>                LEFT JOIN Core.Contract p ON p.ContractId = c.ParentId<br>                WHERE t.PURCH_ORDER_NBR = (CASE WHEN p.Number IS NULL THEN '' ELSE p.Number + '/' END + c.Number))<br>            ,MOD<br>        FROM @t t <br>        LEFT JOIN (<br>            SELECT cm.ModificationNumber, p.PurchaseOrderNumber<br>                FROM Core.ContractModification cm<br>                JOIN Core.Contract c ON cm.ContractId = c.ContractId<br>                JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>            ) ex ON ex.ModificationNumber = t.MOD AND ex.PurchaseOrderNumber = t.PURCH_ORDER_NBR<br>        WHERE ex.ModificationNumber is null;<br><br>        DISABLE TRIGGER audit_Core_ContractModification ON Core.ContractModification;<br><br>        UPDATE Core.ContractModification SET [Data] = '{}' WHERE [Data] IS NULL;<br><br>        UPDATE cm SET<br>                cm.BuyerName                                       = BUYER_NAME<br>                ,cm.AwardStatus                                     = AWARD_STATUS<br>                ,cm.FpdsStatus                                      = FPDS_STATUS<br>                ,cm.ReasonForModification                           = REASON_FOR_MODIFICATION_NAME <br>                ,cm.DescriptionOfRequirement                        = SHORT_DSC <br>                ,cm.DateSigned                                      = DATE_SIGNED<br>                ,cm.EffectiveDate                                   = EFFECTIVE_DATE<br>				,cm.LastToOrderDate									= IDV_LAST_DATE<br>                ,cm.CompletionDate                                  = CURRENT_COMPLETION_DATE<br>                ,cm.UltimateCompletionDate                          = ULTIMATE_COMPLETION_DATE<br>                --AMOUNT FIELDS<br>                ,cm.Obligation                                      = t.Obligation<br>                ,cm.BaseAndExercised                                = t.Base_And_Exercised <br>                ,cm.BaseAndAll                                      = t.Base_And_All <br>                ,cm.TotalObligation                                 = t.Total_Obligation <br>                ,cm.TotalBaseAndExercised                           = t.Total_Base_And_Exercised <br>                ,cm.TotalBaseAndAll                                 = t.Total_Base_And_All  <br>                --END AMOUNT FIELDS<br>                ,cm.SolicitationIdentifier                          = SOLICITATION_IDENTIFIER <br>                ,cm.ContractingOfficeAgencyIdentifier               = AGENCY_IDENTIFIER <br>                ,cm.ContractingOfficeAgencyName                     = AGENCY_NAME <br>                ,cm.ContractOfficeIdentifier                        = OFFICE_CODE <br>                ,cm.ContractOfficeName                              = OFFICE_NAME <br>                ,cm.FundingAgencyIdentifier                         = FUNDING_AGENCY <br>                -- NEW FIELD (10/3)<br>                ,cm.FundingOfficeId                                 = FA_DODAAC <br>                -- END NEW FIELD (10/3)<br>                ,cm.ForeignFunding                                  = FOREIGN_CONTRACT <br>                ,cm.ReferencedAgencyIdentifier                      = REFERENCED_AGENCY_ID <br>                ,cm.Initiative                                      = t.[INITIATIVE] <br>                ,cm.FeePaidForUserIdv                               = FEE_PAID_USE_IDV<br>                ,cm.VendorDuns                                      = DUNS <br>                ,cm.VendorName                                      = TP_NAME <br>                ,cm.VendorDoingBusinessAsName                       = DOING_BUSINESS_AS_NAME <br>                ,cm.VendorStreet                                    = STREET_NBR <br>                ,cm.VendorCity                                      = CITY <br>                ,cm.VendorState                                     = [STATE]<br>                ,cm.VendorZip                                       = POSTAL_CD <br>                ,cm.VendorCountry                                   = COUNTRY <br>                ,cm.VendorPhone                                     = VENDOR_PHONE_NUM <br>                ,cm.VendorFaxNumber                                 = VENDOR_FAX_NUM <br>                ,cm.VendorCongressionalDistrict                     = CONGRESS_DIST_CONTACTOR <br>                ,cm.VendorOrganizationType                          = ORGANIZATIONAL_TYPE <br>                ,cm.VendorNumberOfEmployees                         = VENDOR_EMPLOYEES_NUM<br>                ,cm.VendorCountryOfIncorporation                    = COUNTRY_OF_INCORPORATION <br>                ,cm.VendorAnnualRevenue                             = VENDOR_ANNUAL_REVENUE<br>                ,cm.TypeOfContract                                  = CONTRACT_TYPE_NAME <br>                ,cm.InherentlyGovernmentFunctions                   = INHERENTLY_GOV_FUNCTION <br>                ,cm.MultiyearContract                               = MULTIYEAR_CONTRACT <br>                ,cm.MajorProgram                                    = MAJOR_PROGRAM <br>                ,cm.NationalInterestActionCode                      = NATIONAL_INTEREST_CODE <br>                ,cm.NationalInterestActionName                      = NATIONAL_INTEREST_CODE_NAME <br>                ,cm.CostOrPricingDataCode                           = COST_OR_PRICING_DATA <br>                ,cm.CostOrPricingDataName                           = COST_OR_PRICING_DATA_NAME <br>                ,cm.PurchaseCardUsedAsPaymentMethodCode             = PURCHASE_CARD_PAYMENT_METHOD <br>                ,cm.PurchaseCardUsedAsPaymentMethodName             = PURCHASE_CARD_METHOD_NAME <br>                ,cm.PerformanceBasedServiceAcquisition              = PERF_BASED_CONTRACT <br>                ,cm.ContingencyHumanitarianPeacekeepingOpCode       = CONTINGENCY_OPS <br>                ,cm.ContingencyHumanitarianPeacekeepingOpName       = CONTINGENCY_OPS_NAME <br>                ,cm.ContractFinancingCode                           = CONTRACT_FINANCING <br>                ,cm.ContractFinancingName                           = CONTRACT_FINANCING_NAME <br>                ,cm.CostAccountingStandersClauseCode                = COST_ACCOUNTING_STANDARD <br>                ,cm.CostAccountingStandersClauseName                = COST_ACCOUNT_STANDARD_NAME <br>                ,cm.ConsolidatedContractCode                        = CONSOLIDATED_CONTRACT <br>                ,cm.ConsolidatedContractName                        = CONSOLIDATED_CONTRACT_NAME <br>                ,cm.NumberOfActions                                 = NUMBER_OF_ACTIONS<br>                ,cm.ClingerCohenActCode                             = FA_CLINGER  <br>                ,cm.ClingerCohenActName                             = FA_CLINGER_NAME <br>                ,cm.LaborStandards                                  = LABOR_STATUTES <br>                ,cm.InteragencyContractingAuthorityCode             = INTERAGENCY_CONTRACT_AUTHORITY <br>                ,cm.InteragencyContractingAuthorityName             = INTERAGE_CONTR_AUTHORITY_NAME <br>                ,cm.OtherInteragencyContractingStatutoryAuthority   = OTHER_STATUTORY_AUTHORITY <br>                ,cm.PlaceOfPerformanceStateCode                     = STATE_PERFORM <br>                ,cm.PlaceOfPerformanceStateName                     = STATE_PERFORM_NAME <br>                ,cm.PlaceOfPerformanceCountryCode                   = COUNTRY_PERFORM <br>                ,cm.PlaceOfPerformanceCountryName                   = COUNTRY_PERFORM_NAME <br>                ,cm.PlaceOfPerformanceCityCode                      = CITY_PERFORM <br>                ,cm.PlaceOfPerformanceCityName                      = CITY_PERFORM_NAME <br>                ,cm.PlaceOfPerformanceCongressionalDistrict         = CONGRESS_DIST_POP <br>                ,cm.PlaceOfPerformanceZip                           = ZIP_CODE_POP <br>                ,cm.ExtentCompetedCode                              = EXTENT_COMPETED_NG <br>                ,cm.ExtendCompetedName                              = EXTENT_COMPETED_NAME <br>                ,cm.SolicitationProceduresCode                      = SOLICITATION_PROCEDURES_NG <br>                ,cm.SolicitationProceduresName                      = SOLICITATION_PROCEDURES_NAME <br>                ,cm.TypeOfSetAsideCode                              = TYPE_SET_ASIDE <br>                ,cm.TypeOfSetAsideName                              = TYPE_SET_ASIDE_NAME <br>                ,cm.EvaluatedPreferenceCode                         = EVALUATED_PREFERENCE <br>                ,cm.EvaluatedPreferenceName                         = EVALUATED_PREFERENCE_NAME <br>                ,cm.LocalAreaSetAsideCode                           = LOCAL_AREA_SET_ASIDE <br>                ,cm.LocalAreaSetAsideName                           = LOCAL_AREA_SET_ASIDE_NAME <br>                ,cm.FedBizOppsCode                                  = FEDBIZOPPS <br>                ,cm.FedBizOppsName                                  = FEDBIZOPPS_NAME <br>                ,cm.A76Code                                         = A76 <br>                ,cm.A76Name                                         = A76_ACTION_NAME <br>                ,cm.CommercialItemAcquisitionProceduresCode         = COMMERCIAL_ITEM_ACQUISITION <br>                ,cm.CommercialItemAcquisitionProceduresName         = COMM_ITEM_ACQUISITION_NAME <br>                ,cm.NumberOfOffersReceived                          = NUM_OFFERS_RECD_NG<br>                ,cm.SmallBusinessCompetitivenessDemoProgram         = SMALL_BUSINESS_DEMO <br>                ,cm.SubcontractPlanCode                             = SUBCONTRACT_PLAN_NG <br>                ,cm.SubcontractPlanName                             = SUBCONTRACT_PLAN_NG_NAME <br>                ,cm.PriceEvaluationPercentDifference                = PRICE_EVAL_DIFF<br>                ,cm.[Data] =    JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(<br>                                JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(cm.data,<br>                                '$.KeyPersonnelFirstName', KEY_PERSONNEL_FIRST_NAME)<br>                                ,'$.KeyPersonnelLastName	', KEY_PERSONNEL_LAST_NAME	)<br>                                ,'$.KeyPersonnelEmail	', KEY_PERSONNEL_EMAIL	)<br>                                ,'$.ProjectOfficerFirstName	', PROJ_OFFICER_FIRST_NAME	)<br>                                ,'$.ProjectOfficerLastName	', PROJ_OFFICER_LAST_NAME	)<br>                                ,'$.ProjectOfficerEmail	', PROJ_OFFICER_EMAIL	)<br>                                ,'$.ContractSpecialistFirstName	', CONTR_SPECIALIST_FIRST_NAME	)<br>                                ,'$.ContractSpecialistLastName	', CONTR_SPECIALIST_LAST_NAME	)<br>                                ,'$.ContractSpecialistEmail	', CONTR_SPECIALIST_EMAIL	)<br>                                ,'$.RFCDate	', CAST(RFC_DATE AS VARCHAR(MAX))	)<br>                                ,'$.ContractStatus	', CONTRACT_STATUS	)<br>                                ,'$.ContractStatusName', CONTRACT_STATUS_NAME)<br>                                ,'$.Center	', CENTER	)<br>                                ,'$.IndianSelfDetermination	', INDIAN_SELF_DETERMINATION	)<br>                                ,'$.GreenProductsServices	', GREEN_PRODUCTS_SERVICES	)<br>                                ,'$.GreenProductsServicesDollar	', GREEN_PRODUCTS_SERVICES_DOLL	)<br>                                ,'$.ProcurementAction	', PROCUREMENT_ACTION_NIH	)<br>                                ,'$.ProcurementActionName', PROCUREMENT_ACTION_NAME)<br>                                ,'$.ActivityCode	', ACTIVITY_CODE_NIH	)<br>                                ,'$.ActivityCodeName', ACTIVITY_CODE_NAME)<br>                                ,'$.AdminIC', ADMIN_IC_NIH)<br>                                ,'$.AdminICName', ADMIN_IC_NAME)<br>                                ,'$.FormerNumber	', FORMER_NUM_NIH	)<br>                                ,'$.ADBContractNum	', ADB_CONTRACT_NUM_NIH	)<br>                                ,'$.ActionEffectiveDate	', CAST(ACTION_EFFECTIVE_DATE_NIH AS VARCHAR(MAX))	)<br>                                ,'$.FiscalYear	', FISCAL_YEAR_NIH	)<br>                                ,'$.TotalAwardToDateDollar	', TOTAL_AWD_TO_DATE_DOL_NIH	)<br>                                ,'$.TotalSubPlanDollar	', TOTAL_SUB_PLAN_DOL_NIH	)<br>                                ,'$.SubPlanSmallBusinessGoalDollar	', SUB_PLAN_SM_BUS_GOAL_DOL_NIH	)<br>                                ,'$.SubPlanDisadvatagedDollar	', SUB_PLAN_DISADV_BUS_DOL_NIH	)<br>                                ,'$.SubPlanWomenDollar	', SUB_PLAN_WOMEN_DOL_NIH	)<br>                                ,'$.SubPlanVeteranGoal	', SUB_PLAN_HUBZONE_DOL_NIH	)<br>                                ,'$.SubPlanVeteranGoalDollar	', SUB_PLAN_VET_GOAL_DOL_NIH	)<br>                                ,'$.SubPlanDisabledVeteranDollar	', SUB_PLAN_DIS_VET_DOL_NIH	)<br>                                ,'$.HumanSubjectsCode	', HUMAN_SUBJECTS_CODE_NIH	)<br>                                ,'$.HumanSubjectsCodeName', HUMAN_SUBJECTS_CODE_NAME)<br>                                ,'$.HumanEmbryonicStemCell	', HUMAN_EMB_STEM_CELL	)<br>                                ,'$.LastRecOnFile	', LAST_REC_ON_FILE_NIH	)<br>                                ,'$.CurrentFundEndDate	', CAST(CURRENT_FUND_END_DATE_NIH AS VARCHAR(MAX))	)<br>                                ,'$.AgentCode	', AGENT_CODE_NIH	)<br>                                ,'$.CompServiceCenterName	', COMP_SERVICE_CENTER_NAME	)<br>                                ,'$.SBIRResearchCode	', SBIR_RESEARCH_CODE_NIH	)<br>                                ,'$.AIDSRelatedDollar	', AIDS_RELATED_DOL_NIH	)<br>                                ,'$.AIDSAFFContract	', AIDS_AFF_CONTRACT_NIH	)<br>                                ,'$.PrivacyActApplicable	', PRIVACY_ACT_APPLICABLE_NIH	)<br>                                ,'$.GovProperty	', GOV_PROPERTY_NIH	)<br>                                ,'$.GovPropertyName', GOV_PROPERTY_NAME)<br>                                ,'$.Children	', CHILDREN_NIH	)<br>                                ,'$.ChildrenName', CHILDREN_NAME)<br>                                ,'$.ChildrenRepB1	', CHILDREN_REP_B1_NIH	)<br>                                ,'$.ChildrenRepB1Name', CHILDREN_REP_B1_NAME)<br>                                ,'$.ClinicalResearchMinB1	', CLINICAL_RES_MIN_B1_NIH	)<br>                                ,'$.ClinicalResearchMinB1Name', CLINICAL_RES_MIN_B1_NAME)<br>                                ,'$.ClinicalResearchGenB1	', CLINICAL_RES_GEN_B1_NIH	)<br>                                ,'$.ClinicalResearchGenB1Name', CLINICAL_RES_GEN_B1_NAME)<br>                                ,'$.Phase3Trial	', PHASE3_TRIAL_NIH	)<br>                                ,'$.Phase3TrialName', PHASE3_TRIAL_NAME)<br>                                ,'$.ExceptionTracking	', EXCEPTION_TRACKING_NIH	)<br>                                ,'$.ExceptionTrackingName', EXCEPTION_TRACKING_NAME)<br>                                ,'$.ContractOfficerFirstName', CONTRACT_OFFICER_FIR_NAME_NIH	)<br>                                ,'$.ContractOfficerLastName	', CONTRACT_OFFICER_LAS_NAME_NIH	)<br>                                ,'$.TaskOrderAgreemnet	', TASK_ORDER_AGREEMENT_NIH	)<br>                                ,'$.TaskOrderAgreemnetName', TASK_ORDER_AGREE_NAME)<br>                                ,'$.RfpIfbNum	', RFP_IFB_NUM_NIH	)<br>                                ,'$.ContractAdminCloseDate	', CAST(CONTRACT_ADMIN_CLOSE_DATE_NIH AS VARCHAR(MAX))	)<br>                                ,'$.FCRDCMemoArea	', FCRDC_MEMO_AREA_NIH	)<br>                                ,'$.FCRDCMemoAreaName', FCRDC_MEMO_AREA_NAME)<br>                                ,'$.AnimalsResearch	', ANIMALS_RESEARCH_NIH	)<br>                                ,'$.ChimpanzeeInvolvemnet	', CHIMPANZEE_INVOLVEMENT	)<br>                                ,'$.ActionDollars	', ACTION_DOLLARS	)<br>                                ,'$.ProgramClassCode	', PROGRAM_CLASS_CODE_NIH	)<br>                                ,'$.DelegatedProcurement	', DELEGATED_PROCUREMENT	)<br>                                ,'$.EmergencyContact	', EMERGENCY_CONTRACT	)<br>                                ,'$.PastPerformanceReporting', PAST_PERFORMANCE_REPORTING)<br>        FROM Core.ContractModification AS cm<br>        JOIN Core.Contract AS c ON cm.ContractId = c.ContractId<br>        JOIN @purchOrderNumber p ON c.ContractId = p.ContractId<br>        JOIN @t t ON t.PURCH_ORDER_NBR = p.PurchaseOrderNumber AND t.MOD = cm.ModificationNumber;<br><br>        ENABLE TRIGGER audit_Core_ContractModification ON Core.ContractModification;<br><br>    IF EXISTS (<br>    SELECT * <br>    FROM   sys.columns <br>    WHERE  object_id = OBJECT_ID(N'[CORE].[Contract]') <br>            AND name = 'PurchaseOrderNumber'<br>    ) <br>    BEGIN  <br>        DROP INDEX [Core].[Contract].IX_CORE_CONTRACT_PURCHASE_ORDER_NUMBER;<br>        ALTER TABLE Core.Contract <br>            DROP COLUMN PurchaseOrderNumber;<br>    END<br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportModsFromNvision</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td width="25%">
<span class="TableHeaderText">Name</span>			</td>
			<td class="TableCellSpaceHolder20Px">
			</td>
			<td>
<span class="TableHeaderText">Value</span>			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Parameters</span>			</td>
			<td>
			</td>
			<td>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportVendorsFromNvision</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Schema</span>			</td>
			<td>
			</td>
			<td>
				<span class="TableContent">
<span class="TableContent">dbo</span>				</span>
			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Create Statement</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">CREATE PROCEDURE [dbo].[ImportVendorsFromNvision] <br>AS<br>BEGIN <br>    DECLARE @inStr varchar(max);<br>    DECLARE @qry varchar(max);<br>    DECLARE @t TABLE(<br>		         Vendor_Name varchar(128) <br>				,Vendor_DUNS varchar(128) INDEX IX1<br>				,TP_KEY varchar(128) INDEX IX2<br>				,STREET varchar(128)<br>				,CITY varchar(128)<br>				,STATE varchar(128)<br>				,ZIP varchar(128)<br>            );<br><br>        SET @qry = null;<br><br>            set @qry = '--Include Contract number (logic applied), Task Order Count (if applicable), Vendor Name, Vendor DUNS<br>										SELECT DISTINCT<br>											 Vendor_Name<br>											,Vendor_DUNS<br>											,TP_KEY<br>											,STREET<br>											,CITY<br>											,STATE<br>											,ZIP<br>										FROM<br>										(SELECT<br>											DISTINCT CASE<br>												WHEN PIID IS NOT NULL THEN PIID<br>												WHEN PIID IS NULL THEN PARENT_SEGMENT<br>											END AS ULTIMATE_PIID<br>											,CASE<br>												WHEN a.REFERENCED_PIID IS NOT NULL AND a.REFERENCED_PIID != ''000000000000000'' THEN a.REFERENCED_PIID<br>												WHEN REFERENCED_PIID IS NULL THEN PARENT_SEGMENT<br>												WHEN REFERENCED_PIID = ''000000000000000'' THEN NULL<br>											END AS ULTIMATE_RefPIID<br>											,a.AWARD_TYPE<br>											,t.TP_NAME AS Vendor_Name<br>											,t.DUNS AS Vendor_DUNS<br>											,t.TRADING_PARTNER_KEY AS TP_KEY<br>											,t.STREET_NAME AS STREET<br>											,t.CITY<br>											,t.STATE<br>											,t.POSTAL_CD AS ZIP<br>										FROM BF_AWD_HDR_ACQ_MV a <br>										LEFT JOIN BF_OBLIG_DTLS_ACQ_MV o ON o.AWARD_KEY = a.AWARD_KEY<br>										LEFT JOIN BF_TRADING_PARTNER_DIM_VW t ON t.TRADING_PARTNER_KEY = a.TRADING_PARTNER_KEY<br>										WHERE 1=1<br>										AND (o.IC = ''NCI'' OR a.BUYER_IC = ''NCI'')<br>										AND a.AWARD_CATEGORY_NAME != ''P-CARD''<br>										AND a.VERSION_NBR != ''-1''<br>										ORDER BY ULTIMATE_RefPIID, ULTIMATE_PIID<br>										) t<br>                                        WHERE Vendor_Name IS NOT NULL<br>										ORDER BY Vendor_DUNS';<br>            INSERT @t <br>            EXECUTE (@qry) AT nVision;<br><br>        SELECT * FROM @t;<br>        DISABLE TRIGGER audit_Core_Vendor ON Core.Vendor;<br><br>        UPDATE v SET v.Address = t.Street + '\n' + t.CITY+', ' + t.[STATE] + ' ' + t.ZIP, v.TradingPartnerKey = t.TP_KEY, v.Name = t.Vendor_Name<br>        FROM Core.Vendor AS v<br>        JOIN @t t ON t.Vendor_DUNS = v.Duns;<br><br>        ENABLE TRIGGER audit_Core_Vendor ON Core.Vendor;<br><br>        INSERT INTO Core.Vendor (Duns, Address, Name, Enabled, Email)<br>        SELECT <br>            t.Vendor_DUNS<br>            ,t.Street + '\n' + t.CITY+', ' + t.[STATE] + ' ' + t.ZIP<br>            ,t.Vendor_Name<br>            ,1<br>            ,''<br>        FROM @t AS t WHERE NOT EXISTS (SELECT * FROM Core.Vendor WHERE Duns = Vendor_DUNS)<br>        <br><br>END</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Name</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">ImportVendorsFromNvision</span>			</td>
		</tr>
		<tr class="TableRow2">
			<td>
			</td>
			<td>
<span class="TableContent">Procedure Type</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Result Unknown</span>			</td>
		</tr>
		<tr class="TableRow1">
			<td>
			</td>
			<td>
<span class="TableContent">Data Model</span>			</td>
			<td>
			</td>
			<td>
<span class="TableContent">Physical</span>			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<p>
	</p>
	<p>
	</p>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="Category">
Appears In			</td>
		</tr>
		<tr>
			<td class="TableCellSpaceHolder5PxTall">
			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td colSpan="4" class="TableHeaderLine">
			</td>
		</tr>
		<tr>
			<td colSpan="4" class="TableHeaderLine1">
			</td>
		</tr>
		<tr class="TableHeader">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td>
<span class="TableHeaderText">Diagram</span>			</td>
		</tr>
		<tr>
			<td colSpan="2" class="TableHeaderLine2">
			</td>
		</tr>
		<tr class="TableRow1">
			<td class="TableCellSpaceHolder10Px">
			</td>
			<td>
				<span class="TableContent">
					<div style="float: left; width: 18px !important;height: 18px !important;background-image:url(../images/icons/ERDiagram.png) !important; background-image:url(''); filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='../images/icons/ERDiagram.png'); background-repeat: no-repeat;">
					</div>
&nbsp;<a href="ERDiagram_VKVgHBaAUrCKOXOo.html" class="ItemLink">oasys : Entity Relationship Diagram</a>				</span>
			</td>
		</tr>
	</table>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="TableCellSpaceHolder1PxTall">
			</td>
		</tr>
		<tr>
			<td class="TableFooter">
			</td>
		</tr>
	</table>
	<div style="height: 20px;">
	</div>
	<table border="0" cellpadding="0" width="100%" cellspacing="0">
		<tr>
			<td class="FooterLine">
			</td>
		</tr>
	</table>
	<div class="HeaderText">
NCI Business Architecture	</div>
</body>
</html>
